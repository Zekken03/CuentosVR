<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mi personaje VR</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/@c-frame/aframe-physics-system@4.2.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>

    <script>
      // Componente para que el personaje mire al jugador
      AFRAME.registerComponent("mirar-al-jugador", {
        tick: function () {
          const camera = document.querySelector("[camera]").object3D;
          this.el.object3D.lookAt(camera.position);
        }
      });

      // Componente mejorado para limitar movimiento
      AFRAME.registerComponent('limitar-movimiento', {
        init: function () {
          this.originalY = 1.6; // Altura inicial del jugador
        },
        tick: function () {
          const el = this.el;
          const pos = el.object3D.position;
          
          // Si el jugador cae por debajo de cierto nivel
          if (pos.y < 0.5) {
            pos.y = this.originalY;
            const body = el.body;
            if (body) {
              body.velocity.set(0, 0, 0);
              body.angularVelocity.set(0, 0, 0);
            }
          }
        }
      });

      // Cambiar de escena o mover al jugador
      document.addEventListener("DOMContentLoaded", function () {
        const puerta = document.querySelector("#puerta1");
        puerta.addEventListener("click", function () {
          const player = document.querySelector("#player");
          player.setAttribute("position", "5 1.6 -5");
          
          // Resetear física después de teletransportar
          const body = player.body;
          if (body) {
            body.velocity.set(0, 0, 0);
            body.angularVelocity.set(0, 0, 0);
          }
        });
      });
    </script>
  </head>

  <body>
    <a-scene physics="debug: false; gravity: 0 -9.8 0; maxInterval: 0.016; iterations: 20;" shadow="type: pcfsoft">
      <!-- Cámara VR con altura correcta -->
      <a-entity id="player" 
                camera
                mirar-al-jugador
                wasd-controls
                position="4 1.6 -1.5"
                rotation="0 90 0"
                dynamic-body="mass: 1; shape: box; halfExtents: 0.3 0.8 0.3; linearDamping: 0.5"
                limitar-movimiento>
        
        <a-cursor
          fuse="true"
          fuse-timeout="3000"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
          material="color: black; shader: flat; opacity: 0.2">
        </a-cursor>
        <a-sound id="fondoMusical" src="#musica-fondo" loop="true" volume="0.5" position="4 1.6 -1.5"></a-sound>
      </a-entity>
      <a-text id="mensaje-agua" value="Para cerrar la llave,\napuntale con la mirada " 
        visible="false"
        position="-2.5 2.5 -1"  
        rotation="0 90 0"
        align="center"
        color="white"  
        width="4"
        font="kelsonsans"></a-text>
      <a-text id="mensaje-logro" value="¡Lo lograste! Cuidaste el agua" 
        visible="false"
        position="-0.5 3 -3" 
        align="center"
        color="orange"
        width="4"
        font="kelsonsans"
        scale="2 2 2"></a-text>

      <a-assets>
        <audio id="musica-fondo" src="music.mp3"></audio>
      </a-assets>
      
     

      <!-- Suelo con física mejorada -->
      <a-plane position="0 -0.1 0" 
               rotation="-90 0 0" 
               width="100" 
               height="100" 
               color="#edd89f" 
               static-body="shape: none;"
               physics-shape="shape: plane; offset: 0 0 0"
               shadow="receive: true">
      </a-plane>

      <!-- Resto de tu escena... -->
      <a-sky color="#ECECEC"></a-sky>
      
      <!-- Personaje compuesto -->
      <a-entity id="personaje"   cambiar-imagen>
        <!-- Imagen original -->
        <a-image id="imagen-gota" src="gota.png" position="-2 1 1" scale="2 2 2" rotation="0 90 0"></a-image>


      
      </a-entity>
      

      <!-- Puerta para cambiar escena -->
      <a-box id="puerta1" position="0 1 -5" depth="0.1" height="2" width="1" color="brown"></a-box>

      <!-- Paredes formando un cuadrado -->
      <a-box position="0 2.4 -3.5" depth="0.1" height="5" width="10" src="fondo1.jpeg" static-body></a-box> <!-- Pared frontal -->
      <a-box position="-4.2 3.5 -3.5" depth="0.5" height="1.5" width="1.7" src="cajon.jpeg" static-body></a-box>
      <a-box position="-1.5 0.7 -2.5" depth="1" height="1.5" width="4" src="gabinete.jpeg" static-body></a-box>
      <a-image id="imagen-detener" position="-1 2.2 -2.6" depth="1" height="1.5" width="1.6" src="llave.png" rotation="0 60 0"static-body></a-image>
      <a-box position="2.7 0.7 -2.5" depth="1" height="1.5" width="3" src="cocina.jpeg" static-body></a-box>
      <a-image position="-1 3.5 -1" depth="0.1" height="1.5" width="1.5" src="luz.png" rotation="0 90 0"    static-body></a-image>
      <a-box position="0 2.4 3.5" depth="0.1" height="5" width="10" src="puerta.png" static-body></a-box> <!-- Pared trasera -->
      <a-box id="paredVentana" position="-5 2.4 0" depth="7" height="5" width="0.1" src="ventana.png" static-body></a-box> <!-- Pared izquierda -->
      <a-box position="5 2.4 0" depth="7" height="5" width="0.1" src="cocina.png" static-body></a-box> <!-- Pared derecha -->
    </a-scene>
    <a-image id="imagen-gota" src="gota.png" position="0 1.5 -3" cambiar-imagen></a-image>
<a-image id="imagen-detener" src="boton.png" position="2 1.5 -3"></a-image>


<script>
  AFRAME.registerComponent("cambiar-imagen", {
    init: function () {
      const el = this.el;
      const imagen = el.querySelector("#imagen-gota");
      const imagenes = ["gota.png", "gota1.png", "gota2.png"];
      let index = 0;
      let intervalId = null;

      const audio = new Audio('audio.mp3');
      const audio2 = new Audio('music.mp3');
      const audioFinal = new Audio('water.mp3'); // Este es el sonido que se repite en loop
      const audioClick = new Audio('happy.mp3');

      audio2.volume = 0.1;
      audio2.loop = true;

      // Hacer que audioFinal se repita en loop
      audioFinal.loop = true;

      const mensaje = document.querySelector("#mensaje-agua");
      const mensajeLogro = document.querySelector("#mensaje-logro"); // Nuevo mensaje
      let animacionIniciada = false;
      let sonidoDetenido = false;

      const iniciarAnimacion = () => {
        if (animacionIniciada) return;
        animacionIniciada = true;

        intervalId = setInterval(() => {
          index = (index + 1) % imagenes.length;
          imagen.setAttribute("src", imagenes[index]);
        }, 500);

        audio.play();
        audio2.play();

        // Empezar a reproducir water.mp3 en loop
        audioFinal.play();

        setTimeout(() => {
          clearInterval(intervalId);
          intervalId = null;
          imagen.setAttribute("src", "gota.png");

          // Mostrar mensaje al iniciar el sonido final
          mensaje.setAttribute("visible", "true");

        }, 49000);
      };

      el.addEventListener("mouseenter", iniciarAnimacion);

      const boton = document.querySelector("#imagen-detener");
      boton.addEventListener("click", () => {
        if (sonidoDetenido) return;
        sonidoDetenido = true;

        // Detener water.mp3 al hacer clic en la imagen
        audioFinal.pause();
        audioFinal.currentTime = 0; // Reiniciar el tiempo de reproducción a 0
        audioClick.play();

        // Ocultar el mensaje de la llave
        mensaje.setAttribute("visible", "false");

        // Mostrar el mensaje de éxito
        mensajeLogro.setAttribute("visible", "true");

        // Ocultar el mensaje de éxito después de 3 segundos (puedes ajustarlo)
        setTimeout(() => {
          mensajeLogro.setAttribute("visible", "false");
        }, 3000);
      });
    }
  });
</script>


     
    
    <script>
      AFRAME.registerComponent("activar-musica", {
  init: function () {
    this.el.addEventListener("mouseenter", () => {
      const sonido = document.querySelector("#fondoMusical");

      // Añadir pequeña pausa para asegurar que esté listo
      setTimeout(() => {
        if (!sonido.components.sound.isPlaying) {
          sonido.components.sound.playSound();
        }
      }, 100); // Espera 100ms antes de intentar reproducir
    });
  }
});

    </script>
    
  </body>
</html>